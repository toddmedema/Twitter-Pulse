function Twitter(){this.init_time=(new Date).getTime();this.start_time=0;this.end_time=(new Date).getTime();this.new_search=!1;this.min_update_interval=1e3;this.update_interval=this.min_update_interval;this.error=!1;this.error_add_to_interval=1e4;this.tweets=new hash_table;this.tweets_dict={};this.tweets_per_second={}}Twitter.prototype.update=function(e){for(var t=0;t<SEARCHES.length;t++){var n=SEARCHES[t];t===SEARCHES.length-1?TWITTER.update_thread(n,!0):TWITTER.update_thread(n)}if((new Date).getTime()>TWITTER.end_time){setTimeout(TWITTER.update,TWITTER.update_interval);TWITTER.start_time=TWITTER.end_time;TWITTER.end_time=(new Date).getTime()+TWITTER.update_interval}};Twitter.prototype.update_thread=function(e,t){var n=enc_name(e),r=TWITTER.tweets_dict[e].total_count;$.getJSON("http://search.twitter.com/search.json?q="+encodeURIComponent(e)+"&rpp=100&callback=?",function(i){i.error!==undefined&&!TWITTER.error?TWITTER.on_error():$(i.results).each(function(t,n){TWITTER.add_tweet(e,this)});i.error===undefined&&TWITTER.error&&!TWITTER.new_search&&TWITTER.off_error();if(SEARCHES.indexOf(e)!==-1){var s=(TWITTER.tweets_dict[e].total_count-r)*1e3/TWITTER.update_interval;TWITTER.tweets_per_second[n].unshift(s)}t&&(TWITTER.new_search=!0)})};Twitter.prototype.on_error=function(){mixpanel.track("ERROR: Twitter over rate",{on_duration:((new Date).getTime()-TWITTER.init_time)/1e3});TWITTER.error=!0;TWITTER.update_interval+=TWITTER.error_add_to_interval;$("#tweet_view_error").show()};Twitter.prototype.off_error=function(){TWITTER.error=!1;TWITTER.update_interval-=TWITTER.error_add_to_interval;$("#tweet_view_error").hide()};Twitter.prototype.add_tweet=function(e,t){var n=hashString(t.text),r=enc_name(e);if(!TWITTER.tweets.hasItem(n)){TWITTER.tweets.setItem(n,{text:t.text,from_user:t.from_user});var i=t.text.toLowerCase(),s=[];for(var o=0;o<SEARCHES.length;o++){var u=SEARCHES[o];i.indexOf(u)!==-1&&s.push(u)}if(s.length>0){var a=TWITTER.tweets_dict;for(var f=0;f<s.length;f++){a=a[s[f]];a.total_count+=1}a.tweets.push(n);if(s.length===UI.active_filters.length){var l=!0;for(var f=0;f<s.length;f++)UI.active_filters.indexOf(s[f])===-1&&(l=!1);if(l){t.keywords=s;UI.add_tweet(t)}}}}};Twitter.prototype.add_search=function(e,t){if(COLORS.length>=COLOR_MAX)alert("Max simultaneous search count reached");else{var n="#000000";while(COLORS.indexOf(n)!==-1)n=random_color();e=e.toLowerCase();var r=enc_name(e);if(SEARCHES.indexOf(e)!=-1)alert("You're already searching for that phrase");else{SEARCHES.push(e);COLORS.push(n);TWITTER.tweets_per_second[r]=[0];TWITTER.recursive_insert(TWITTER.tweets_dict,e);UI.add_search(e)}TWITTER.update_interval=Math.max(TWITTER.min_update_interval*SEARCHES.length,1e3);t||mixpanel.track("Search added",{term:e,total:SEARCHES.length});TWITTER.end_time-(new Date).getTime()>1e3&&TWITTER.update()}};Twitter.prototype.recursive_insert=function(e,t){for(var n in e)e.hasOwnProperty(n)&&TWITTER.recursive_insert(e[n],t);e[t]={total_count:0,tweets:[]}};Twitter.prototype.remove_search=function(e){var t=SEARCHES.indexOf(e);if(t!=-1){var n=enc_name(e);SEARCHES.splice(t,1);COLORS.splice(t,1);for(var r=t;r<=SEARCHES.length;r++)$(".color"+r).removeClass("color"+r).addClass("color"+(r-1));TWITTER.recursive_remove(TWITTER.tweets_dict,e);delete TWITTER.tweets_per_second[n];TWITTER.update_interval=Math.max(TWITTER.min_update_interval*SEARCHES.length,1e3);for(var r=0;r<UI.tweet_queue.length;r++){var i=UI.tweet_queue[r],s=i.keywords.length;for(var o=0;o<s;o++)SEARCHES.indexOf(i.keywords[o])===-1&&(s-=1);if(s<2){UI.tweet_queue.splice(r,1);r-=1}}mixpanel.track("Search removed",{term:e,total:SEARCHES.length})}};Twitter.prototype.recursive_remove=function(e,t){delete e[t];for(var n in e)e.hasOwnProperty(n)&&TWITTER.recursive_remove(e[n],t)};